<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
                <li class="breadcrumb-item active">Reports</li>
            </ol>
        </nav>
        
        <h1 class="mb-4">
            <i class="fas fa-file-alt me-2"></i>
            Shakespeare Analysis Reports
        </h1>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-users me-2"></i>
                    Character Reports
                </h5>
            </div>
            <div class="card-body">
                <p class="card-text">Generate detailed character analysis reports including line counts, word usage, and character interactions.</p>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="generateCharacterReport()">
                        <i class="fas fa-chart-bar me-2"></i>
                        Character Analysis Report
                    </button>
                    <button class="btn btn-outline-primary" onclick="generateCharacterComparison()">
                        <i class="fas fa-balance-scale me-2"></i>
                        Character Comparison Report
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-font me-2"></i>
                    Word Analysis Reports
                </h5>
            </div>
            <div class="card-body">
                <p class="card-text">Create comprehensive word frequency reports, vocabulary analysis, and linguistic patterns.</p>
                <div class="d-grid gap-2">
                    <button class="btn btn-success" onclick="generateWordFrequencyReport()">
                        <i class="fas fa-list-ol me-2"></i>
                        Word Frequency Report
                    </button>
                    <button class="btn btn-outline-success" onclick="generateVocabularyReport()">
                        <i class="fas fa-book me-2"></i>
                        Vocabulary Analysis Report
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-theater-masks me-2"></i>
                    Play Reports
                </h5>
            </div>
            <div class="card-body">
                <p class="card-text">Generate comprehensive play analysis reports with statistics, summaries, and insights.</p>
                <div class="d-grid gap-2">
                    <button class="btn btn-info" onclick="generatePlaySummaryReport()">
                        <i class="fas fa-file-text me-2"></i>
                        Play Summary Report
                    </button>
                    <button class="btn btn-outline-info" onclick="generatePlayComparisonReport()">
                        <i class="fas fa-columns me-2"></i>
                        Play Comparison Report
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cog me-2"></i>
                    Report Configuration
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label for="playSelect" class="form-label">Select Play:</label>
                        <select class="form-select" id="playSelect">
                            <option value="">All Plays</option>
                            <% @plays.each_with_index do |(url, name), index| %>
                                <option value="<%= index %>"><%= name %></option>
                            <% end %>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="reportFormat" class="form-label">Format:</label>
                        <select class="form-select" id="reportFormat">
                            <option value="html">HTML Report</option>
                            <option value="pdf">PDF Document</option>
                            <option value="csv">CSV Data</option>
                            <option value="json">JSON Data</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="reportDetail" class="form-label">Detail Level:</label>
                        <select class="form-select" id="reportDetail">
                            <option value="summary">Summary</option>
                            <option value="detailed">Detailed</option>
                            <option value="comprehensive">Comprehensive</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeCharts">
                            <label class="form-check-label" for="includeCharts">
                                Include Charts
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>
                    Recent Reports
                </h5>
            </div>
            <div class="card-body">
                <div id="recentReports">
                    <div class="text-center text-muted">
                        <i class="fas fa-file-alt fa-3x mb-3"></i>
                        <p>No reports generated yet. Create your first report using the options above.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    Report Preview
                </h5>
            </div>
            <div class="card-body">
                <div id="reportPreview">
                    <div class="text-center text-muted">
                        <i class="fas fa-eye fa-3x mb-3"></i>
                        <p>Generate a report to see the preview here.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Report Types
                </h5>
            </div>
            <div class="card-body">
                <div class="accordion" id="reportTypesAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="characterReportsHeader">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#characterReports">
                                Character Reports
                            </button>
                        </h2>
                        <div id="characterReports" class="accordion-collapse collapse" data-bs-parent="#reportTypesAccordion">
                            <div class="accordion-body">
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check text-success me-2"></i>Lines spoken analysis</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Character rankings</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Word usage patterns</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Character interactions</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="wordReportsHeader">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#wordReports">
                                Word Analysis Reports
                            </button>
                        </h2>
                        <div id="wordReports" class="accordion-collapse collapse" data-bs-parent="#reportTypesAccordion">
                            <div class="accordion-body">
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check text-success me-2"></i>Word frequency analysis</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Vocabulary richness</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Linguistic patterns</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Character-specific vocabulary</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="playReportsHeader">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#playReports">
                                Play Reports
                            </button>
                        </h2>
                        <div id="playReports" class="accordion-collapse collapse" data-bs-parent="#reportTypesAccordion">
                            <div class="accordion-body">
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check text-success me-2"></i>Overall statistics</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Play comparisons</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Structural analysis</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Thematic insights</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-download me-2"></i>
                    Export Options
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="exportAllData()">
                        <i class="fas fa-database me-2"></i>
                        Export All Analysis Data
                    </button>
                    <button class="btn btn-outline-success" onclick="exportReportTemplates()">
                        <i class="fas fa-file-code me-2"></i>
                        Export Report Templates
                    </button>
                    <button class="btn btn-outline-info" onclick="scheduleReports()">
                        <i class="fas fa-clock me-2"></i>
                        Schedule Reports
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Report Generation Modal -->
<div class="modal fade" id="reportGenerationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Generating Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Generating...</span>
                    </div>
                    <h6 id="reportProgress">Initializing report generation...</h6>
                    <div class="progress mt-3">
                        <div class="progress-bar" role="progressbar" style="width: 0%" id="progressBar"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let reportHistory = [];

// Character Report Generation
function generateCharacterReport() {
    const playIndex = document.getElementById('playSelect').value;
    const format = document.getElementById('reportFormat').value;
    const detail = document.getElementById('reportDetail').value;
    const includeCharts = document.getElementById('includeCharts').checked;
    
    if (!playIndex) {
        alert('Please select a play first.');
        return;
    }
    
    showReportGenerationModal('Character Analysis Report');
    
    // Simulate report generation
    simulateReportGeneration(() => {
        const reportData = {
            type: 'Character Analysis',
            play: getPlayName(playIndex),
            format: format,
            detail: detail,
            includeCharts: includeCharts,
            timestamp: new Date().toLocaleString(),
            id: Date.now()
        };
        
        addToReportHistory(reportData);
        showReportPreview(reportData);
        hideReportGenerationModal();
    });
}

// Word Frequency Report Generation
function generateWordFrequencyReport() {
    const playIndex = document.getElementById('playSelect').value;
    const format = document.getElementById('reportFormat').value;
    const detail = document.getElementById('reportDetail').value;
    const includeCharts = document.getElementById('includeCharts').checked;
    
    if (!playIndex) {
        alert('Please select a play first.');
        return;
    }
    
    showReportGenerationModal('Word Frequency Report');
    
    simulateReportGeneration(() => {
        const reportData = {
            type: 'Word Frequency Analysis',
            play: getPlayName(playIndex),
            format: format,
            detail: detail,
            includeCharts: includeCharts,
            timestamp: new Date().toLocaleString(),
            id: Date.now()
        };
        
        addToReportHistory(reportData);
        showReportPreview(reportData);
        hideReportGenerationModal();
    });
}

// Play Summary Report Generation
function generatePlaySummaryReport() {
    const playIndex = document.getElementById('playSelect').value;
    const format = document.getElementById('reportFormat').value;
    const detail = document.getElementById('reportDetail').value;
    const includeCharts = document.getElementById('includeCharts').checked;
    
    if (!playIndex) {
        alert('Please select a play first.');
        return;
    }
    
    showReportGenerationModal('Play Summary Report');
    
    simulateReportGeneration(() => {
        const reportData = {
            type: 'Play Summary',
            play: getPlayName(playIndex),
            format: format,
            detail: detail,
            includeCharts: includeCharts,
            timestamp: new Date().toLocaleString(),
            id: Date.now()
        };
        
        addToReportHistory(reportData);
        showReportPreview(reportData);
        hideReportGenerationModal();
    });
}

// Other report functions
function generateCharacterComparison() {
    alert('Character Comparison Report: This feature analyzes and compares different characters across plays. Implementation in progress!');
}

function generateVocabularyReport() {
    alert('Vocabulary Analysis Report: This feature provides detailed vocabulary analysis including word complexity and usage patterns. Implementation in progress!');
}

function generatePlayComparisonReport() {
    alert('Play Comparison Report: This feature compares multiple plays side by side. Implementation in progress!');
}

// Utility functions
function getPlayName(index) {
    const plays = <%= @plays.map { |url, name| name }.to_json %>;
    return plays[parseInt(index)] || 'Unknown Play';
}

function showReportGenerationModal(reportType) {
    document.getElementById('reportProgress').textContent = `Generating ${reportType}...`;
    document.getElementById('progressBar').style.width = '0%';
    const modal = new bootstrap.Modal(document.getElementById('reportGenerationModal'));
    modal.show();
}

function hideReportGenerationModal() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('reportGenerationModal'));
    if (modal) modal.hide();
}

function simulateReportGeneration(callback) {
    const steps = [
        'Analyzing play data...',
        'Processing character information...',
        'Calculating statistics...',
        'Generating charts...',
        'Formatting report...',
        'Finalizing document...'
    ];
    
    let currentStep = 0;
    const interval = setInterval(() => {
        if (currentStep < steps.length) {
            document.getElementById('reportProgress').textContent = steps[currentStep];
            document.getElementById('progressBar').style.width = `${((currentStep + 1) / steps.length) * 100}%`;
            currentStep++;
        } else {
            clearInterval(interval);
            setTimeout(callback, 500);
        }
    }, 800);
}

function addToReportHistory(reportData) {
    reportHistory.unshift(reportData);
    updateRecentReports();
}

function updateRecentReports() {
    const container = document.getElementById('recentReports');
    
    if (reportHistory.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-file-alt fa-3x mb-3"></i>
                <p>No reports generated yet. Create your first report using the options above.</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="list-group">';
    reportHistory.slice(0, 5).forEach(report => {
        html += `
            <div class="list-group-item">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${report.type} - ${report.play}</h6>
                    <small>${report.timestamp}</small>
                </div>
                <p class="mb-1">Format: ${report.format.toUpperCase()} | Detail: ${report.detail}</p>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="downloadReport(${report.id})">
                        <i class="fas fa-download me-1"></i>Download
                    </button>
                    <button class="btn btn-outline-info" onclick="viewReport(${report.id})">
                        <i class="fas fa-eye me-1"></i>View
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteReport(${report.id})">
                        <i class="fas fa-trash me-1"></i>Delete
                    </button>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;
}

function showReportPreview(reportData) {
    const preview = `
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">${reportData.type} - ${reportData.play}</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <canvas id="previewChart" width="300" height="200"></canvas>
                    </div>
                    <div class="col-md-6">
                        <h6>Report Summary</h6>
                        <ul class="list-unstyled">
                            <li><strong>Type:</strong> ${reportData.type}</li>
                            <li><strong>Play:</strong> ${reportData.play}</li>
                            <li><strong>Format:</strong> ${reportData.format.toUpperCase()}</li>
                            <li><strong>Detail Level:</strong> ${reportData.detail}</li>
                            <li><strong>Charts Included:</strong> ${reportData.includeCharts ? 'Yes' : 'No'}</li>
                            <li><strong>Generated:</strong> ${reportData.timestamp}</li>
                        </ul>
                        <button class="btn btn-primary btn-sm" onclick="downloadReport(${reportData.id})">
                            <i class="fas fa-download me-1"></i>Download Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('reportPreview').innerHTML = preview;
    
    // Create a sample chart for preview
    setTimeout(() => {
        const ctx = document.getElementById('previewChart');
        if (ctx) {
            new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Character A', 'Character B', 'Character C', 'Character D'],
                    datasets: [{
                        label: 'Lines Spoken',
                        data: [120, 95, 80, 65],
                        backgroundColor: 'rgba(54, 162, 235, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    }, 100);
}

// Report actions
function downloadReport(reportId) {
    const report = reportHistory.find(r => r.id === reportId);
    if (!report) return;
    
    // Create a sample report file
    const reportContent = {
        title: `${report.type} - ${report.play}`,
        generated: report.timestamp,
        format: report.format,
        detail: report.detail,
        data: {
            message: "This is a sample report. In a real implementation, this would contain the actual analysis data."
        }
    };
    
    const blob = new Blob([JSON.stringify(reportContent, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${report.type.replace(/\s+/g, '_')}_${report.play.replace(/\s+/g, '_')}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function viewReport(reportId) {
    const report = reportHistory.find(r => r.id === reportId);
    if (!report) return;
    
    showReportPreview(report);
}

function deleteReport(reportId) {
    if (confirm('Are you sure you want to delete this report?')) {
        reportHistory = reportHistory.filter(r => r.id !== reportId);
        updateRecentReports();
        
        // Clear preview if it was showing the deleted report
        document.getElementById('reportPreview').innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-eye fa-3x mb-3"></i>
                <p>Generate a report to see the preview here.</p>
            </div>
        `;
    }
}

// Export functions
function exportAllData() {
    alert('Export All Data: This feature will export all analysis data in the selected format. Implementation in progress!');
}

function exportReportTemplates() {
    alert('Export Report Templates: This feature will export customizable report templates. Implementation in progress!');
}

function scheduleReports() {
    alert('Schedule Reports: This feature will allow you to schedule automatic report generation. Implementation in progress!');
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateRecentReports();
});
</script>
